services:
  # ─────────────────────────────────────────────
  # BACKEND — Node.js
  # ─────────────────────────────────────────────
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: estofaria_backend
    restart: always
    environment:
      NODE_ENV: production
      PORT: 3001

      DB_HOST: mysql8
      DB_PORT: 3306
      DB_NAME: estofaria
      DB_USER: ${MYSQL_USER}
      DB_PASS: ${MYSQL_PASSWORD}

      JWT_SECRET: ${JWT_SECRET}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
    volumes:
      - backend_uploads:/app/public/uploads
    networks:
      - estofaria-network
      - traefik-net
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=${TRAEFIK_NET}"

      # API em subdomínio ou domínio específico
      - "traefik.http.routers.estofaria-api.rule=Host(`${API_DOMAIN}`)"
      - "traefik.http.routers.estofaria-api.entrypoints=websecure"
      - "traefik.http.routers.estofaria-api.tls=true"
      - "traefik.http.routers.estofaria-api.tls.certresolver=cloudflare"

      - "traefik.http.services.estofaria-api.loadbalancer.server.port=3001"

  # ─────────────────────────────────────────────
  # FRONTEND — React build + Nginx
  # ─────────────────────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - REACT_APP_API_URL=${REACT_APP_API_URL}
    container_name: estofaria_frontend
    restart: always
    depends_on:
      - backend
    volumes:
      - backend_uploads:/usr/share/nginx/html/uploads
    networks:
      - traefik-net
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=${TRAEFIK_NET}"

      - "traefik.http.routers.estofaria-app.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.estofaria-app.entrypoints=websecure"
      - "traefik.http.routers.estofaria-app.tls=true"
      - "traefik.http.routers.estofaria-app.tls.certresolver=cloudflare"

      - "traefik.http.services.estofaria-app.loadbalancer.server.port=80"

      - "traefik.http.middlewares.estofaria-redirect.redirectregex.regex=^https://www.(.+)"
      - "traefik.http.middlewares.estofaria-redirect.redirectregex.replacement=https://$${1}"
      - "traefik.http.routers.estofaria-app.middlewares=estofaria-redirect"

volumes:
  backend_uploads:

networks:
  estofaria-network:
    driver: bridge
  traefik-net:
    external: true
    name: ${TRAEFIK_NET}
